<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.csplatform.user.mapper.TaskMapper">

    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.csplatform.user.entities.Task">
        <id property="id" column="id" />
        <result property="userId" column="user_id" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="priority" column="priority" />
        <result property="isCompleted" column="is_completed" />
        <result property="tags" column="tags" />
        <result property="completionRate" column="completion_rate" />
        <result property="startTime" column="start_time" />
        <result property="endTime" column="end_time" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
    </resultMap>

    <!-- 插入非空字段 -->
    <insert id="insertSelective" parameterType="com.csplatform.user.entities.Task"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO tasks
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="title != null and title != ''">title,</if>
            <if test="content != null and content != ''">content,</if>
            <if test="priority != null">priority,</if>
            <if test="isCompleted != null">is_completed,</if>
            <if test="tags != null and tags != ''">tags,</if>
            <if test="completionRate != null">completion_rate,</if>
            <if test="startTime != null">start_time,</if>
            <if test="endTime != null">end_time,</if>
            <if test="createdAt != null">created_at,</if>
            <if test="updatedAt != null">updated_at,</if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="title != null and title != ''">#{title},</if>
            <if test="content != null and content != ''">#{content},</if>
            <if test="priority != null">#{priority},</if>
            <if test="isCompleted != null">#{isCompleted},</if>
            <if test="tags != null and tags != ''">#{tags},</if>
            <if test="completionRate != null">#{completionRate},</if>
            <if test="startTime != null">#{startTime},</if>
            <if test="endTime != null">#{endTime},</if>
            <if test="createdAt != null">#{createdAt},</if>
            <if test="updatedAt != null">#{updatedAt},</if>
        </trim>
    </insert>

    <!-- 批量插入任务 -->
    <insert id="batchInsert" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tasks
        (user_id, title, content, priority, is_completed, tags, completion_rate, start_time, end_time, created_at, updated_at)
        VALUES
        <foreach collection="list" item="task" separator=",">
            (
            #{task.userId},
            #{task.title},
            #{task.content},
            #{task.priority},
            <choose>
                <when test="task.isCompleted != null">#{task.isCompleted}</when>
                <otherwise>false</otherwise>
            </choose>,
            #{task.tags},
            <choose>
                <when test="task.completionRate != null">#{task.completionRate}</when>
                <otherwise>0</otherwise>
            </choose>,
            #{task.startTime},
            #{task.endTime},
            <choose>
                <when test="task.createdAt != null">#{task.createdAt}</when>
                <otherwise>NOW()</otherwise>
            </choose>,
            <choose>
                <when test="task.updatedAt != null">#{task.updatedAt}</when>
                <otherwise>NOW()</otherwise>
            </choose>
            )
        </foreach>
    </insert>

    <!-- 更新任务（非空字段） -->
    <update id="updateByPrimaryKeySelective" parameterType="com.csplatform.user.entities.Task">
        UPDATE tasks
        <set>
            <if test="title != null and title != ''">title = #{title},</if>
            <if test="content != null and content != ''">content = #{content},</if>
            <if test="priority != null">priority = #{priority},</if>
            <if test="isCompleted != null">is_completed = #{isCompleted},</if>
            <if test="tags != null and tags != ''">tags = #{tags},</if>
            <if test="completionRate != null">completion_rate = #{completionRate},</if>
            <if test="startTime != null">start_time = #{startTime},</if>
            <if test="endTime != null">end_time = #{endTime},</if>
            <if test="updatedAt != null">updated_at = #{updatedAt},</if>
        </set>
        WHERE id = #{id}
        <if test="userId != null">AND user_id = #{userId}</if>
    </update>

    <!-- 查询任务列表（带分页和条件） -->
    <select id="selectTasks" parameterType="map" resultMap="BaseResultMap">
        SELECT * FROM tasks
        WHERE is_deleted = 0
        <if test="userId != null">AND user_id = #{userId}</if>
        <if test="isCompleted != null">AND is_completed = #{isCompleted}</if>
        <if test="priority != null">AND priority = #{priority}</if>
        <if test="keyword != null and keyword != ''">
            AND (title LIKE CONCAT('%', #{keyword}, '%') OR content LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="startDate != null">AND DATE(created_at) >= #{startDate}</if>
        <if test="endDate != null">AND DATE(created_at) &lt;= #{endDate}</if>
        ORDER BY
        <choose>
            <when test="sortBy != null and sortBy != ''">${sortBy} ${sortOrder},</when>
        </choose>
        created_at DESC
        <if test="limit != null">LIMIT #{limit}</if>
        <if test="offset != null">OFFSET #{offset}</if>
    </select>

    <!-- 统计任务数量 -->
    <select id="countTasks" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM tasks
        WHERE is_deleted = 0
        <if test="userId != null">AND user_id = #{userId}</if>
        <if test="isCompleted != null">AND is_completed = #{isCompleted}</if>
        <if test="priority != null">AND priority = #{priority}</if>
    </select>

</mapper>